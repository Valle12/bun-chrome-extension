#!/usr/bin/env bun
// @bun
// IMPORT // Do not remove!
import{rm as N}from"fs/promises";import{resolve as g}from"path";import{watch as A}from"chokidar";import{dirname as F,extname as x,relative as R,resolve as r}from"path";import{posix as $}from"path/posix";import{stdin as f}from"process";import{compile as w}from"sass";var d={name:"exportRemover",setup(e){let n=S(e.config.entrypoints);e.onLoad({filter:n},async(i)=>{return{contents:(await Bun.file(i.path).text()).replace(/\bexport(?:\s+default)?\s+/g,"")}})}},C={name:"sassCompiler",setup(e){e.onLoad({filter:/\.scss$/},(n)=>{return{contents:w(n.path).css,loader:"css"}})}};function y(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function S(e){let n=process.platform==="win32",i=e.filter((o)=>o.endsWith(".ts"));if(i.length===0)return/^(?!)$/;let s=`^(?:${i.map(y).join("|")})$`;if(n)s=s.replace(/\//g,"\\\\");return new RegExp(s)}class m{manifest;config;ws;cwd=process.cwd();ignoreKeys=["version","description"];icons=[".png",".bmp",".gif",".ico",".jpeg"];originalServiceWorker;compose=r(this.cwd,"compose.js");firstConnect=!0;package=Bun.env.LOCAL==="true"?this.posixPath(this.cwd):"bun-chrome-extension-dev";constructor(e,n={}){this.manifest=e,this.originalServiceWorker=this.manifest.background?.service_worker;let i={minify:!0,sourcemap:"none",outdir:r(this.cwd,"dist")};this.config={minify:n.minify??i.minify,sourcemap:n.sourcemap??i.sourcemap,outdir:r(n.outdir??i.outdir)}}async setServiceWorker(){let e=await Bun.file(r(import.meta.dir,"composeTemplate.js")).text();if(!this.manifest.background||!await Bun.file(r(this.cwd,this.originalServiceWorker)).exists())console.log("No background service worker found, creating one...");else console.log("Background service worker found, creating compose..."),e=e.replaceAll("// IMPORT // Do not remove!",`import "./${this.relativePosixPath(this.cwd,this.originalServiceWorker)}";`);await Bun.write(this.compose,e),this.manifest.background={service_worker:this.compose,type:"module"}}openWebsocket(e){if(this.ws=e,this.firstConnect)this.firstConnect=!1,this.ws.send("reload");console.log("Connection established!")}startServer(){Bun.serve({fetch(e,n){if(n.upgrade(e,{data:"reload"}))return;return new Response("Upgrade failed!",{status:500})},websocket:{open:(e)=>this.openWebsocket(e),message:()=>{}},port:Bun.env.LOCAL==="true"?8080:3000})}async initDev(){if(await this.setServiceWorker(),f.isTTY)f.setRawMode(!0),f.resume(),f.setEncoding("utf8");let e=A(this.cwd,{awaitWriteFinish:{stabilityThreshold:100,pollInterval:10},ignored:(n)=>r(this.cwd,n).includes(this.config.outdir)||n.includes("compose.js")||n.includes("node_modules")||n.includes(".git"),ignoreInitial:!0});e.on("all",async()=>{console.clear(),console.log("Rebuild project...");let n=await import(r(process.cwd(),`manifest.ts?cacheBust=${Date.now()}${Math.random()}`));if(this.manifest=n.manifest,await this.setServiceWorker(),await this.parse(),this.ws.send("reload"),process.send)process.send("rebuild complete")}),f.on("data",(n)=>{if(n.toString()==="\x03")console.log("Closing watcher..."),e.close(),process.exit()})}async parse(){await this.parseManifest(),await this.writeManifest()}async parseManifest(){if(this.manifest.background)this.manifest.background.type="module";let e=[];if(this.extractPaths(e),e.length!==0){let n=await Bun.build({entrypoints:[...e],minify:this.config.minify,outdir:this.config.outdir,sourcemap:this.config.sourcemap,plugins:[d,C]}),i=JSON.stringify(this.manifest,(t,s)=>{if(typeof s==="string")return this.posixPath(s);return s});for(let t of n.outputs){if(t.path.endsWith(".js")&&t.loader==="html"&&t.kind==="entry-point"||t.path.endsWith(".css")&&t.loader==="html"&&t.kind==="asset"||t.loader==="file"&&t.kind==="asset")continue;let s=this.relativePosixPath(this.config.outdir,t.path),o=t.path;if(t.path.endsWith(".js")&&t.loader==="file"&&t.kind==="entry-point"){let a=await import(t.path),_=r(F(t.path),a.default);s=this.relativePosixPath(this.config.outdir,_),o=s;let p=o.split("-");p.pop(),s=p.join("")+x(s)}let c=e.findIndex((a)=>{return a=a.replaceAll(".ts",".js"),a.includes($.sep+s)});if(c===-1){console.error("Could not find entrypoint for output",e,t);continue}let E=e[c];e.splice(c,1),i=i.replaceAll(E,this.relativePosixPath(this.config.outdir,r(this.config.outdir,o)))}this.manifest=JSON.parse(i)}}async writeManifest(){let e=r(this.config.outdir,"manifest.json"),n=JSON.stringify(this.manifest,null,2);await Bun.write(e,n)}extractPaths(e=[],n="",i=this.manifest){for(let[t,s]of Object.entries(i)){let o=n===""?"":".";if(typeof s==="object"){if(t==="ts")t="js",i[t]=s,delete i.ts;this.extractPaths(e,n+o+t,s)}else if(typeof s==="string"&&x(s)&&!this.ignoreKeys.includes(t)){let c=this.posixPath(r(s));i[t]=c,e.push(c)}}}relativePosixPath(e,n){return this.posixPath(R(e,n))}posixPath(e){if(e.includes("://"))return e;return e.replaceAll(/\\/g,"/").replaceAll("//","/")}}function K(e){return{manifest_version:3,...e}}function D(e){return e}await N(g(process.cwd(),"dist"),{recursive:!0,force:!0});var M=g(process.cwd(),"bce.config.ts"),b;if(await Bun.file(M).exists())b=(await import(M)).default;var T=await import(g(process.cwd(),"manifest.ts")),L=T.manifest,B=process.argv.length===3&&process.argv[2]==="--dev",l=new m(L,b);if(B)await l.initDev();await l.parse();if(B){if(l.startServer(),process.send)process.send("websocket ready")}else console.log("Build completed!");export{K as defineManifest,D as defineConfig};
